function iniciarPagina(){MostrarCargando();setTimeout(function(){IniciarDataTable(CargarTablaUsuarios)},800);obtenerRoles();obtenerDispositivos();$("#frmDispositivos").hide();$("input#telefonoE").bind("keyup paste",function(){this.value=this.value.replace(/[^0-9]/g,"")});$(document).on("click","#btnRefrescar",function(){IniciarDataTable(CargarTablaUsuarios)});$(document).on("click","#btnCargar",function(){ValidarPermisoCRUD("CU")?$("#Miarchivo").click():mensajeBloqueoToast()});$("#cedula").focusout(function(){$("#idDelegado").val("");$("#chkDelegado").prop("checked",!1).change()});$("#Miarchivo").change(function(){MostrarCargando();var n=$("#Miarchivo")[0].files[0],t=n.name.split(".").pop();if(t=t.toLowerCase(),n){if(t!=="txt"){alertaError("Cargar archivo","Solo se permiten archivos .txt");CerrarCargando();return}if(n.size>5242880){alertaError("Cargar archivo","El tamaño del archivo no debe sobrepasar los 5 MB");CerrarCargando();return}data=new FormData;data.append("file",n);$.ajax({url:apiUrl+"/api/login/Usuario/CargarArchivo",type:"POST",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},data:data,cache:!1,processData:!1,contentType:!1,success:function(n){CerrarCargando();alertaInfo("Guardar datos",n);CargarTablaUsuarios()},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("cargar archivo",mensajeError);CerrarCargando()}});$("#Miarchivo").val(null)}});$("#chkDelegado").change(function(){$(this).is(":checked")?validarDelegado($("#cedula").val()):$("#idDelegado").val("")});$(document).on("click","#btnMasivo",function(){ValidarPermisoCRUD("EM")?$("#modal-lg-masivo").modal("show"):mensajeBloqueoToast()});$(document).on("click","#btnAgregar",function(){ValidarPermisoCRUD("C")?($("#modal-lg-usuario").data("tipo","guardar"),$("#modal-lg-usuario").modal("show"),$("#lblUsuario").text("NUEVO USUARIO"),$("#cedula").removeAttr("disabled"),$("#cedula").val(""),$("#nombre").val(""),$("#telefono").val(""),$("#idDelegado").val(""),$("#chkactivo").prop("checked",!0).change(),$("#chkDelegado").prop("checked",!1).change()):mensajeBloqueoToast()});$(document).on("click",".tooltipImgM",function(){if(ValidarPermisoCRUD("U")){var t=$(this).closest("tr").find("td:eq(1)").text(),i=$(this).closest("tr").find("td:eq(2)").text(),n=$(this).closest("tr").find("td:eq(3) p").attr("data-idR"),r=$(this).closest("tr").find("td:eq(3)").text(),u=$(this).closest("tr").find("td:eq(4)").text(),f=$(this).closest("tr").find("td:eq(5)").text(),e=$(this).closest("tr").find("td:eq(6)").text(),o=$(this).closest("tr").find("td:eq(7)").text();ValidarPermisoCRUD("UR")||($("#selRol").prop("disabled",!0),$("#selRol").empty(),$("#selRol").append('<option value="'+n+'">'+r+"<\/option>"));$("#modal-lg-usuario").data("tipo","modificar");$("#modal-lg-usuario").modal("show");$("#lblUsuario").text("MODIFICAR USUARIO");$("#cedula").prop("disabled",!0);$("#cedula").val(t);$("#nombre").val(i);$("#telefono").val(f);$("#selRol").val(n).change();u==="Activo"?$("#chkactivo").prop("checked",!0).change():$("#chkactivo").prop("checked",!1).change();e==="SI"?$("#chkDelegado").prop("checked",!0).change():$("#chkDelegado").prop("checked",!1).change();$("#idDelegado").val(o)}else mensajeBloqueoToast()});$(document).on("click",".tooltipImgB",function(){if(ValidarPermisoCRUD("D")){var n=$(this).closest("tr").find("td:eq(1)").text();Swal.close();Swal.fire({title:"Eliminar Datos",html:"¿Desea Eliminar el usuario <b>"+n+"<\/b>?",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",cancelButtonText:"Cancelar",confirmButtonText:"Aceptar"}).then(function(t){t.value&&EliminarDatos(n)})}else mensajeBloqueoToast()});$(document).on("click",".tooltipImgE",function(){if(ValidarPermisoCRUD("EP")){var n=$(this).closest("tr").find("td:eq(1)").text(),t=$(this).closest("tr").find("td:eq(2)").text(),i=$(this).closest("tr").find("td:eq(5)").text();$("#modal-Envio").modal("show");$("#ckTelefonoE").is(":checked")||$("#ckTelefonoE").click();$("#cedulaE").val(n);$("#nombreE").val(t);$("#telefonoE").val(i);$("#ckCambiaPin").prop("checked",!1).change();$("#ckEnviaD").prop("checked",!1).change();$("#frmDispositivos").hide()}else mensajeBloqueoToast()});$(document).on("click","#btnGuardar",function(){validarDatosPantalla()!==1&&(Swal.close(),Swal.fire({title:"Guardar Datos",text:"¿Desea guardar los datos?",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",cancelButtonText:"Cancelar",confirmButtonText:"Aceptar"}).then(function(n){n.value&&($("#modal-lg-usuario").modal("hide"),GuardarModificarPantalla($("#modal-lg-usuario").data("tipo")))}))});$(document).on("click","#ckTelefonoE",function(){$("#ckTelefonoE").is(":checked")?$("#telefonoE").attr("disabled","disabled"):$("#telefonoE").removeAttr("disabled")});$(document).on("click","#btnEnviar",function(){if($("#telefonoE").val().length<8)$("#ckTelefonoE").is(":checked")&&$("#ckTelefonoE").click(),$("#telefonoE").focus();else{var n=$("#ckEnviaD").is(":checked")?"D":"C";telefonoEnvioPin=$("#telefonoE").val();Swal.close();Swal.fire({title:"Guardar Datos",text:"¿Desea enviar el pin al usuario?",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",cancelButtonText:"Cancelar",confirmButtonText:"Aceptar"}).then(function(t){t.value&&($("#modal-Envio").modal("hide"),EnviarMensajeTexto(n))})}});$(document).on("click","#btnEnviarM",function(){Swal.close();Swal.fire({title:"Guardar Datos",text:"¿Desea ejecutar el proceso masivo de envío masivo de pines de acceso?",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",cancelButtonText:"Cancelar",confirmButtonText:"Aceptar"}).then(function(n){n.value&&($("#modal-lg-masivo").modal("hide"),enviarSMSMasivo())})});$("#ckEnviaD").change(function(){this.checked?$("#frmDispositivos").show():$("#frmDispositivos").hide()})}function validarPermisos(){$("#content .fa-lock").remove();ValidarPermisoCRUD("C")?"":$("#btnAgregar").append('<span class="fa fa-lock pl-2"><\/span>');ValidarPermisoCRUD("EM")?"":$("#btnMasivo").append('<span class="fa fa-lock pl-2"><\/span>');ValidarPermisoCRUD("CU")?"":$("#btnCargar").after('<span class="fa fa-lock pl-2 text-danger"><\/span>');ValidarPermisoCRUD("U")?"":$("#TblUpdate").append('<span class="fa fa-lock text-danger"><\/span>');ValidarPermisoCRUD("UR")?"":$("#lbSelRol").text("Rol de Usuario: ").append('<span class="fa fa-lock text-danger"><\/span>');ValidarPermisoCRUD("D")?"":$("#TblDelete").append('<span class="fa fa-lock text-danger"><\/span>');ValidarPermisoCRUD("EP")?"":$("#TblEnviarPin").append('<span class="fa fa-lock text-danger"><\/span>')}function CargarTablaUsuarios(){$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/ListadoUsuarios",contentType:"application/json; charset=utf-8",dataType:"JSON",error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Seleccionar Usuarios",mensajeError);CerrarCargando()},success:function(n){CargarFilas(n);CerrarCargando()}})}function spanEstado(n){return n==="A"?'<small class="badge badge-success">Activo<\/small>':'<small class="badge badge-danger">Inactivo<\/small>'}function IniciarDataTable(n){tabla=objtabla.DataTable({dom:"Bfrtip",buttons:[{extend:"excelHtml5",text:"EXCEL",exportOptions:{columns:[0,1,2,3,4,5,6,7]},title:function(){return nombreReporte},sheetName:"Reporte",className:"btn-success"}],fnDrawCallback:function(){var n=objtabla.DataTable();n.data().length===0?(n.buttons(".buttons-excel").disable(),n.buttons(".btn-add").disable()):(n.buttons(".buttons-excel").enable(),n.buttons(".btn-add").enable())},columns:[{width:"5%",className:"textoCentrado text-bold"},null,null,null,{className:"textoCentrado"},{className:"textoCentrado text-bold"},{width:"10%",className:"textoCentrado"},{width:"10%",className:"textoCentrado"},{width:"5%",sortable:!1,className:"textoCentrado"},{width:"5%",sortable:!1,className:"textoCentrado"},{width:"5%",sortable:!1,className:"textoCentrado"}],bDestroy:!0,ordering:!0,bDeferRender:!0,paging:!1,scrollY:$(document).height()-350+"px",scrollX:!0,scrollCollapse:!0,scroller:!0,autoWidth:!1,responsive:!0});$(".buttons-excel").after('<button type="button" class="btn  bg-gradient-danger  btn-add" id="btnMasivo" style="margin-left:8px;">ENVIAR PIN MASIVO<\/button>');$(".buttons-excel").after('<button type="button" class="btn bg-gradient-primary btn-add" id="btnAgregar" style="margin-left:8px;">NUEVO USUARIO<\/button>');$("#btnMasivo").after('<button type="button" class="btn  bg-gradient-secondary  btn-add" id="btnRefrescar" style="margin-left:8px;"><i class="nav-icon fas fa-redo"><\/i><\/button>');$("#tablaUsuarios tbody").on("click","tr",function(){$(this).hasClass("selected")||(tabla.$("tr.selected").removeClass("selected"),$(this).addClass("selected"))});n();validarPermisos()}function CargarFilas(n){objtabla.dataTable().fnClearTable();var t=[];n.map(function(n){t.push([n.Id_usuario,n.Login,n.Nombre,"<p style='margin:0px' data-idR='"+n.Id_rol+"'>"+n.Nombre_rol+"<\/p>",spanEstado(n.I_estado),n.Telefono,n.I_delegado==="S"?"SI":"NO",n.Id_delegado===0?"":n.Id_delegado,'<img class="tooltipImgM" src="images/Iconos/update.png" style="cursor:pointer" data-toggle="tooltip" title="Modificar" />','<img class="tooltipImgB" src="images/Iconos/delete.png" style="cursor:pointer" data-toggle="tooltip" title="Eliminar" />','<img class="tooltipImgE" src="images/Iconos/send.png" style="cursor:pointer" data-toggle="tooltip" title="Enviar Token" />'])});objtabla.dataTable().fnAddData(t,!0);tabla.draw()}function obtenerRoles(){$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/ListadoRoles",contentType:"application/json; charset=utf-8",error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Carga roles",mensajeError)},success:function(n){CargarComboRoles(n)}})}function CargarComboRoles(n){$("#selRol").empty();n.map(function(n){$("#selRol").append('<option value="'+n.Id_rol+'">'+n.Nombre+"<\/option>");$("#selRolM").append('<option value="'+n.Id_rol+'">'+n.Nombre+"<\/option>")});$("#selRolM").append('<option value="0">TODOS<\/option>')}function GuardarDatos(){MostrarCargando();DatosU.Login=$("#cedula").val();DatosU.Nombre=$("#nombre").val();DatosU.Telefono=$("#telefono").val();DatosU.Id_Rol=$("#selRol").val();DatosU.User_modifica=sessionStorage.Cedula;DatosU.I_estado=$("#chkactivo").is(":checked")?"A":"I";DatosU.I_delegado=$("#chkDelegado").is(":checked")?"S":"N";DatosU.Id_delegado=$("#idDelegado").val();$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/InsertarUsuario",data:JSON.stringify(DatosU),contentType:"application/json; charset=utf-8",dataType:"JSON",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Guardar datos",mensajeError);CerrarCargando()},success:function(n){n.Error===0?(alertaExito("Guardar datos","Datos Guardados correctamente"),CargarTablaUsuarios(),CerrarCargando()):(alertaError("Guardar datos",n.Mensaje),CerrarCargando())}})}function ModificarDatos(){MostrarCargando();DatosU.Login=$("#cedula").val();DatosU.Nombre=$("#nombre").val();DatosU.Telefono=$("#telefono").val();DatosU.Id_Rol=$("#selRol").val();DatosU.I_estado=$("#chkactivo").is(":checked")?"A":"I";DatosU.User_modifica=sessionStorage.Cedula;DatosU.I_delegado=$("#chkDelegado").is(":checked")?"S":"N";DatosU.Id_delegado=$("#idDelegado").val();$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/ModificarUsuario",data:JSON.stringify(DatosU),contentType:"application/json; charset=utf-8",dataType:"JSON",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Guardar datos",mensajeError);CerrarCargando()},success:function(n){n.Error===0?(alertaExito("Guardar datos","Datos Modificados correctamente"),CargarTablaUsuarios(),CerrarCargando()):(alertaError("Guardar datos",n.Mensaje),CerrarCargando())}})}function EliminarDatos(n){MostrarCargando();DatosU.Login=n;DatosU.User_modifica=login;$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/EliminarUsuario",data:JSON.stringify(DatosU),contentType:"application/json; charset=utf-8",dataType:"JSON",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Guardar datos",mensajeError);CerrarCargando()},success:function(n){n.Error===0?(alertaExito("Eliminar usuario","Usuario eliminado correctamente"),CargarTablaUsuarios(),CerrarCargando()):(alertaError("Eliminar usuario",n.Mensaje),CerrarCargando())}})}function validarDatosPantalla(){return $("#cedula").val().length<7?(alertaError("Datos pantalla","La cédula debe ser mayor a 7 carac"),1):$.trim($("#nombre").val()).length<5?(alertaError("Datos Pantalla","El nombre debe ser mayor a 5 caracteres"),1):$.trim($("#telefono").val()).length<8?(alertaError("Datos Pantalla","La descripción abreviada de la pantalla debe ser mayor a 5 caracteres"),1):$("#selRol").val()===undefined||$("#selRol").val()===null?(alertaError("Datos Pantalla","Debe seleccionar un rol"),1):$("#selRol").val().length<1?(alertaError("Datos Pantalla","Debe seleccionar un rol"),1):0}function GuardarModificarPantalla(n){n==="guardar"?GuardarDatos():ModificarDatos()}function EnviarMensajeTexto(n){n==="D"?EnviarDatosD():EnviarDatos()}function EnviarDatos(){MostrarCargando();DatosSMS.Login=$("#cedulaE").val();DatosSMS.Indgenera=$("#ckCambiaPin").is(":checked")?"S":"N";DatosSMS.Usuario=login;DatosSMS.Tipo="I";DatosSMS.TelefonoAux=telefonoEnvioPin;$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/EnviarSms",data:JSON.stringify(DatosSMS),contentType:"application/json; charset=utf-8",dataType:"JSON",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Envío SMS",mensajeError);CerrarCargando()},success:function(n){n.Error===0?(alertaExito("Envío SMS","Pin enviado correctamente a "+telefonoEnvioPin),CerrarCargando()):(alertaError("Envío SMS",n.Mensaje),CerrarCargando())}})}function EnviarDatosD(){MostrarCargando();var t=$("#selDispositivo option:selected").text(),n={};n.Login=$("#cedulaE").val();n.Indgenera=$("#ckCambiaPin").is(":checked")?"S":"N";n.Usuario=login;n.Id_dispositivo=$("#selDispositivo").val();n.Tipo="I";$.ajax({type:"POST",url:apiUrl+"/api/login/Usuario/EnviarSmsD",data:JSON.stringify(n),contentType:"application/json; charset=utf-8",dataType:"JSON",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Envío SMS",mensajeError);CerrarCargando()},success:function(n){n.Error===0?(alertaExito("Envío SMS","Pin enviado correctamente al dispositivo "+t),CerrarCargando()):(alertaError("Envío SMS",n.Mensaje),CerrarCargando())}})}function validarDelegado(n){var t;t=$("#modal-lg-usuario").data("tipo")==="guardar"?apiUrl+"/api/login/Usuario/BuscarDelegadoI":apiUrl+"/api/login/Usuario/BuscarDelegado";MostrarCargando();DatosU.Login=n;$.ajax({type:"POST",url:t,data:JSON.stringify(DatosU),contentType:"application/json; charset=utf-8",dataType:"JSON",error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("validar delegado",mensajeError);$("#chkDelegado").prop("checked",!1);$("#idDelegado").val("");CerrarCargando()},success:function(n){n===undefined||n===null?(alertaError("validar delegado","No existe delegado asociado a esa cédula. Favor revisar."),$("#chkDelegado").prop("checked",!1),$("#idDelegado").val(""),CerrarCargando()):n.Id_delegado===0?($("#chkDelegado").prop("checked",!1),$("#idDelegado").val(""),alertaError("validar delegado","Este usuario no está registrado como delegado. Favor revisar."),CerrarCargando()):($("#idDelegado").val(n.Id_delegado),CerrarCargando())}})}function enviarSMSMasivo(){MostrarCargando();var n=$("#selRolM").val(),t=$("input:radio[name='optDelegados']:checked").val(),i=$("input:radio[name='optestado']:checked").val(),r=$("#ckCambiaPinM").is(":checked")?"S":"N";$.ajax({type:"GET",url:apiUrl+"/api/Login/Usuario/EnvioSmsMasivo?usuario="+sessionStorage.Cedula+"&idrol="+n+"&i_delegado="+t+"&i_estado="+i+"&genera="+r,contentType:"application/json; charset=utf-8",dataType:"JSON",headers:{Auth:sessionStorage.Cedula+":"+sessionStorage.Token},error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Envío Masivo de sms",mensajeError);CerrarCargando()},success:function(n){n.Error===0?(alertaExito("Envío Masivo SMS",n.Mensaje),CerrarCargando()):(alertaError("Envío Masivo SMS",n.Mensaje),CerrarCargando())}})}function obtenerDispositivos(){$.ajax({type:"POST",url:apiUrl+"/api/login/Dispositivo/ListaDispositivosActivos",contentType:"application/json; charset=utf-8",error:function(n,t,i){mensajeError=n.status+"\n"+n.responseText;"\n"+i;alertaError("Carga dispositivos",mensajeError)},success:function(n){CargarComboDispositivo(n)}})}function CargarComboDispositivo(n){$("#selDispositivo").empty();n.map(function(n){$("#selDispositivo").append('<option value="'+n.Id_dispositivo+'">'+n.Nombre+"<\/option>")})}var apiUrl=sessionStorage.Uri,objtabla=$("#tablaUsuarios"),tabla,nombreReporte="Lista de Usuarios",telefonoEnvioPin,DatosU={Id_usuario:"",Id_delegado:"",Login:"",Clave:"",Nombre:"",F_ult_ingreso:"",User_modifica:"",Terminal:"",Id_rol:"",Nombre_rol:"",Foto:"",Token:"",I_estado:"",Telefono:"",I_delegado:""},DatosSMS={Login:"",Indgenera:"",Usuario:"",Tipo:"",TelefonoAux:""};$(document).ready(function(){iniciarPagina()});